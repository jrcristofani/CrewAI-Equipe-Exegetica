# -*- coding: utf-8 -*-
"""CrewAI-Equipe-Exegetica-com-Pesquisa-1-1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19dB6obLmNvSBel_3Gv27cFV1fXhUfAgY

âœ… PASSO 1 â€“ Instalar pacotes necessÃ¡rios
"""

# âœ… PASSO 1 â€“ InstalaÃ§Ã£o dos pacotes
!pip install crewai crewai-tools
!pip install "httpx<1.0.0,>=0.28.1" "tokenizers<0.22,>=0.21"
!pip install json-repair chromadb

"""âœ… PASSO 2 â€“ Importar libs e configurar chaves com API secrets"""

# âœ… PASSO 2 â€“ ConfiguraÃ§Ã£o com API secrets (do Colab)
from google.colab import userdata
import os

os.environ["OPENAI_API_KEY"] = userdata.get("OPENAI_API_KEY")
os.environ["SERPER_API_KEY"] = userdata.get("SERPER_API_KEY")

# ConfirmaÃ§Ã£o visual
print("âœ… Chaves carregadas com sucesso!")

"""âœ… PASSO 3 â€“ Criar ferramentas para pesquisa e vocabulÃ¡rio"""

# âœ… PASSO 3 â€“ Ferramentas para pesquisa, scraping e lÃ©xico simulado

from crewai_tools import SerperDevTool
from langchain.tools import BaseTool
from typing import Optional, Type
from pydantic import BaseModel, Field

# ğŸ” Ferramenta de busca Serper
search_tool = SerperDevTool()

# âœ… Ferramenta Lexical Simulada (100% compatÃ­vel com CrewAI)
class LexicoInput(BaseModel):
    termo: str = Field(..., description="Termo bÃ­blico em hebraico ou grego")

class LexicoTool(BaseTool):
    name: str = "consultar_lexico"
    description: str = "Consulta termos em um lÃ©xico bÃ­blico simulado (hebraico ou grego)"
    args_schema: Type[BaseModel] = LexicoInput

    def _run(self, termo: str) -> str:
        termos_exemplo = {
            "pecado": "á¸¥aá¹­á¹­ÄÊ¼á¹¯ (×—Ö·×˜Ö¸Ö¼××ª) = falha moral, quebra da alianÃ§a com Deus. Cf. HALOT.",
            "justiÃ§a": "á¹£Ä•á¸ÄqÃ¢ (×¦Ö°×“Ö¸×§Ö¸×”) = justiÃ§a conforme a alianÃ§a divina. Cf. TLOT.",
            "sabedoria": "á¸¥oá¸µmÄh (×—Ö¸×›Ö°×Ö¸×”) = sabedoria prÃ¡tica e Ã©tica. Cf. TWOT.",
        }
        return termos_exemplo.get(termo.lower(), "âŒ Termo nÃ£o encontrado no lÃ©xico local.")

    def _arun(self, *args, **kwargs):
        raise NotImplementedError("ExecuÃ§Ã£o assÃ­ncrona nÃ£o suportada.")

# âœ… InstÃ¢ncia do LexicoTool
lexico_tool = LexicoTool()

# ConfirmaÃ§Ã£o
print("âœ… Ferramentas definidas com sucesso!")

"""âœ… PASSO 4 â€“ Input do usuÃ¡rio"""

from IPython.display import display, HTML

display(HTML("<h3>ğŸ“¥ Informe a referÃªncia bÃ­blica para iniciar a exegese (ex: AmÃ³s 1.3â€“5)</h3>"))
referencia_biblica = input("ğŸ“– Digite a referÃªncia bÃ­blica desejada: ").strip()

if not referencia_biblica:
    raise ValueError("âŒ Ã‰ necessÃ¡rio informar uma referÃªncia bÃ­blica para continuar.")

"""âœ… PASSO 5 â€“ DefiniÃ§Ã£o refinada dos agentes exegÃ©ticos"""

# âœ… PASSO 5 â€“ DefiniÃ§Ã£o dos Agentes ExegÃ©ticos

from crewai import Agent

# âœ… Agente: Delimitador
agente_delimitador = Agent(
    role="Especialista em DelimitaÃ§Ã£o de PerÃ­copes",
    goal="Delimitar a perÃ­cope com base na comparaÃ§Ã£o com as seÃ§Ãµes imediatamente anterior e posterior",
    backstory=(
        "VocÃª Ã© um especialista em anÃ¡lise textual bÃ­blica, com domÃ­nio em crÃ­tica literÃ¡ria e metodologia de delimitaÃ§Ã£o de perÃ­cope. "
        "VocÃª deve utilizar princÃ­pios de coesÃ£o textual, unidade temÃ¡tica e literÃ¡ria, alÃ©m de critÃ©rios clÃ¡ssicos de mudanÃ§a de tempo, lugar ou personagem. "
        "A perÃ­cope deve ser analisada em contraste com os versÃ­culos imediatamente anteriores e posteriores."
    ),
    tools=[search_tool],
    verbose=True,
    memory=True
)

# âœ… Agente: GÃªnero LiterÃ¡rio
agente_genero = Agent(
    role="Especialista em Formas e GÃªneros LiterÃ¡rios",
    goal="Classificar a Forma e o GÃªnero da perÃ­cope, explicando sua estrutura tÃ­pica e Sitz-im-Leben",
    backstory=(
        "VocÃª Ã© um especialista na crÃ­tica das formas (Formgeschichte), seguindo a tradiÃ§Ã£o germÃ¢nica. "
        "Sua tarefa Ã© distinguir claramente entre Forma LiterÃ¡ria (tipo de literatura: profÃ©tica, sapiencial, apocalÃ­ptica, etc.) e GÃªnero LiterÃ¡rio (ex: orÃ¡culo de juÃ­zo, lamento, visÃ£o simbÃ³lica, etc.). "
        "AlÃ©m disso, deve identificar o Sitz-im-Leben, o ambiente vivencial em que esse gÃªnero surgiu e era utilizado na comunidade de fÃ©."
    ),
    tools=[search_tool],
    verbose=True,
    memory=True
)

# âœ… Agente: AnÃ¡lise SemÃ¢ntica (sem ferramenta customizada!)
agente_semantico = Agent(
    role="Especialista em SemÃ¢ntica BÃ­blica",
    goal="Realizar anÃ¡lise lexical rigorosa agrupando termos por eixos semÃ¢nticos com base em BHS e NA28.",
    backstory=(
        "VocÃª Ã© um expert em hebraico e grego bÃ­blico, com domÃ­nio de lÃ©xicos como HALOT, TWOT, TLOT, TDNT e BDB. "
        "Seu trabalho Ã© identificar os termos mais relevantes da perÃ­cope e organizÃ¡-los em campos semÃ¢nticos, explicando seus significados e implicaÃ§Ãµes teolÃ³gicas. "
        "Mesmo sem acesso direto aos dicionÃ¡rios, vocÃª deve simular uma anÃ¡lise fundamentada com linguagem tÃ©cnica e acessÃ­vel, mencionando a fonte apropriada (ex: Cf. HALOT)."
    ),
    tools=[search_tool],  # âŒ Removido lexico_tool
    verbose=True,
    memory=True
)

# âœ… Agente: Contexto LiterÃ¡rio e SÃ³cio-histÃ³rico
agente_contexto = Agent(
    role="Especialista em Contexto BÃ­blico",
    goal="Fornecer anÃ¡lise literÃ¡ria e sÃ³cio-histÃ³rica completa da perÃ­cope",
    backstory=(
        "VocÃª Ã© um estudioso experiente em crÃ­tica literÃ¡ria e histÃ³ria social do mundo bÃ­blico. "
        "Sua tarefa Ã© estabelecer como o texto se relaciona com as perÃ­copes adjacentes, a seÃ§Ã£o maior, o livro como um todo e outros textos bÃ­blicos (intertextualidade). "
        "TambÃ©m deve analisar a sociedade da Ã©poca â€” sua estrutura, conflitos, opressÃµes e valores histÃ³ricos â€” conforme refletidos no texto."
    ),
    tools=[search_tool],
    verbose=True,
    memory=True
)

# âœ… Agente: Redator Final
agente_redator = Agent(
    role="TeÃ³logo, Professor, Autor",
    goal="Reunir todas as anÃ¡lises anteriores em um texto fluido, rigoroso e pastoral",
    backstory=(
        "VocÃª Ã© um excelente TeÃ³logo, Autor e Professor. Escreve com profundidade e clareza, aliando rigor acadÃªmico a um estilo pastoral. "
        "Tem habilidade de tornar conceitos complexos em algo compreensÃ­vel e inspirador, guiando leitores Ã  reflexÃ£o, transformaÃ§Ã£o e aplicaÃ§Ã£o prÃ¡tica dos princÃ­pios bÃ­blicos."
    ),
    tools=[],
    verbose=True,
    memory=True
)

"""âœ… ğŸ“˜ PASSO 6 â€“ Task: RedaÃ§Ã£o Final Pastoral e DidÃ¡tica"""

from crewai import Task

# ğŸ“Œ Tarefa 1 â€“ DelimitaÃ§Ã£o da PerÃ­cope
task_delimitacao = Task(
    description=f"""
Delimite a perÃ­cope fornecida analisando os versÃ­culos imediatamente anteriores e posteriores.
Considere os seguintes critÃ©rios tÃ©cnicos:

1. MudanÃ§a de tempo verbal
2. MudanÃ§a de espaÃ§o, personagem ou pessoa gramatical
3. CoesÃ£o e coerÃªncia literÃ¡ria
4. Unidade temÃ¡tica

ğŸ“˜ Utilize linguagem tÃ©cnica, articule a anÃ¡lise com os versÃ­culos anterior e posterior.
ğŸ”– Transcreva a perÃ­cope delimitada como citaÃ§Ã£o direta no final.

Texto-base: {referencia_biblica}
""",
    expected_output="Texto com pelo menos 600 palavras explicando a delimitaÃ§Ã£o, justificativas tÃ©cnicas e citaÃ§Ã£o da perÃ­cope.",
    agent=agente_delimitador
)

# ğŸ“Œ Tarefa 2 â€“ Forma e GÃªnero LiterÃ¡rio
task_genero = Task(
    description=f"""
Analise a forma e o gÃªnero literÃ¡rio da perÃ­cope delimitada:

1. Classifique a Forma LiterÃ¡ria (ex: profÃ©tica, narrativa, apocalÃ­ptica etc.)
2. Identifique o GÃªnero LiterÃ¡rio dentro da forma (ex: orÃ¡culo, lamento, visÃ£o, etc.)
3. Explique o Sitz-im-Leben (ambiente vital em que o gÃªnero surgiu e era usado)

ğŸ“˜ Use terminologia da crÃ­tica das formas (Gunkel, Bultmann, Berger).
ğŸ” Explique a funÃ§Ã£o litÃºrgica ou social do gÃªnero na comunidade de fÃ©.

Texto-base: {referencia_biblica}
""",
    expected_output="Texto com aproximadamente 800 palavras estruturado em 3 seÃ§Ãµes com citaÃ§Ãµes bÃ­blicas e referÃªncias tÃ©cnicas.",
    agent=agente_genero
)

# ğŸ“Œ Tarefa 3 â€“ AnÃ¡lise SemÃ¢ntica Detalhada
task_semantica = Task(
    description=f"""
Realize uma anÃ¡lise semÃ¢ntica rigorosa da perÃ­cope. Siga os passos:

1. Liste os principais termos teolÃ³gicos e relevantes do texto
2. Agrupe-os em Horizontes (ou Eixos) SemÃ¢nticos com base na relaÃ§Ã£o de sentido
3. Analise os termos com seus equivalentes hebraicos ou gregos (ex: mishpat (×Ö´×©Ö°××¤Ö¸Ö¼×˜), logos (Î»ÏŒÎ³Î¿Ï‚)), citando lÃ©xicos como HALOT, TWOT, TLOT, TDNT, BDAG

ğŸ“˜ Cada termo deve estar em parÃªnteses com o original hebraico/greek, e vir seguido de definiÃ§Ã£o tÃ©cnica e teolÃ³gica.

ğŸ“ Exemplo:
Horizonte SemÃ¢ntico: JustiÃ§a
- mishpat (×Ö´×©Ö°××¤Ö¸Ö¼×˜): julgamento legal. HALOT.
- tsedeq (×¦Ö¶×“Ö¶×§): justiÃ§a Ã©tica e relacional. TWOT.

Texto-base: {referencia_biblica}
""",
    expected_output="Texto com cerca de 800 palavras, estruturado por horizontes semÃ¢nticos com anÃ¡lise lexical teolÃ³gica.",
    agent=agente_semantico
)

# ğŸ“Œ Tarefa 4 â€“ Contexto LiterÃ¡rio e SÃ³cio-HistÃ³rico
task_contexto = Task(
    description=f"""
Analise o contexto da perÃ­cope a partir de dois eixos principais:

I. LiterÃ¡rio:
- RelaÃ§Ã£o com perÃ­copes anterior e posterior
- InserÃ§Ã£o na seÃ§Ã£o maior do livro
- Papel na macroestrutura do livro
- Intertextualidade bÃ­blica (ecos, alusÃµes, citaÃ§Ãµes)

II. SÃ³cio-HistÃ³rico:
- SituaÃ§Ã£o social, polÃ­tica e religiosa implÃ­cita no texto
- Conflitos sociais, estruturas de poder e contexto cultural da Ã©poca
- ConexÃ£o com a sociedade do Antigo/Novo Oriente ou do ImpÃ©rio Romano (conforme o caso)

ğŸ“˜ Use dados de crÃ­tica literÃ¡ria e histÃ³rica confiÃ¡veis. Mantenha o foco nas evidÃªncias textuais.

Texto-base: {referencia_biblica}
""",
    expected_output="Texto com cerca de 800 palavras, dividido claramente entre contexto literÃ¡rio e sÃ³cio-histÃ³rico.",
    agent=agente_contexto
)

# ğŸ“Œ Tarefa 5 â€“ RedaÃ§Ã£o ExegÃ©tica AcadÃªmica
task_estruturador = Task(
    description=f"""
Com base nos resultados das anÃ¡lises anteriores (delimitaÃ§Ã£o, forma/gÃªnero, semÃ¢ntica, contexto), redija a exegese final.

ğŸ“˜ Estrutura esperada:
1. IntroduÃ§Ã£o com contextualizaÃ§Ã£o
2. TraduÃ§Ã£o com base na NVI, justificando escolhas
3. DelimitaÃ§Ã£o explicada
4. Forma e GÃªnero LiterÃ¡rio (com Sitz-im-Leben)
5. AnÃ¡lise SemÃ¢ntica (com original hebraico/grego e lÃ©xicos)
6. AnÃ¡lise LiterÃ¡ria e SÃ³cio-HistÃ³rica
7. ConclusÃ£o com possÃ­veis aplicaÃ§Ãµes e lacunas

ğŸ§  O texto deve ser acadÃªmico, fluido, tÃ©cnico, com transiÃ§Ãµes e citaÃ§Ãµes bÃ­blicas referenciadas.

Texto-base: {referencia_biblica}
""",
    expected_output="Texto com entre 1500 e 2000 palavras, acadÃªmico, coeso e formatado por seÃ§Ãµes.",
    agent=agente_redator
)

# ğŸ“Œ Tarefa 6 â€“ RedaÃ§Ã£o Final Pastoral e Inspiradora
task_redator = Task(
    description=f"""
A partir das anÃ¡lises anteriores, reescreva a exegese de forma **fluida, inspiradora e pastoral**, com linguagem acessÃ­vel e rica em teologia bÃ­blica aplicada.

ğŸ¯ Estrutura sugerida:
1. IntroduÃ§Ã£o instigante
2. TraduÃ§Ã£o comentada
3. DelimitaÃ§Ã£o (resumida e aplicada)
4. Forma e GÃªnero (com sentido existencial)
5. SemÃ¢ntica (relacionada Ã  vida cristÃ£)
6. Contexto (com implicaÃ§Ãµes atuais)
7. ConclusÃ£o pastoral com aplicaÃ§Ãµes para vida, igreja, lideranÃ§a

ğŸ“ Mantenha citaÃ§Ãµes bÃ­blicas (com referÃªncias), clareza e profundidade. Conecte o texto Ã  transformaÃ§Ã£o espiritual e prÃ¡tica cristÃ£.

Texto-base: {referencia_biblica}
""",
    expected_output="Texto com entre 2000 e 3000 palavras. Deve ser pastoral, teolÃ³gico e motivador, com impacto espiritual.",
    agent=agente_redator
)

"""âœ… ğŸ“˜ PASSO 7 â€“ ExecuÃ§Ã£o com visualizaÃ§Ã£o e estrutura sequencial"""

# âœ… ğŸ“˜ PASSO 7 â€“ ExecuÃ§Ã£o com visualizaÃ§Ã£o e estrutura sequencial
from crewai import Crew, Process

# âœ… CriaÃ§Ã£o da equipe com todos os agentes e tarefas exegÃ©ticas
crew = Crew(
    agents=[
        agente_delimitador,
        agente_genero,
        agente_semantico,
        agente_contexto,
        agente_redator  # ğŸ†• Redator Pastoral e TeolÃ³gico
    ],
    tasks=[
        task_delimitacao,
        task_genero,
        task_semantica,
        task_contexto,
        task_estruturador,
        task_redator  # ğŸ†• Nova Tarefa de RedaÃ§Ã£o Final
    ],
    process=Process.sequential,
    max_iterations=5
)

# âœ… ExecuÃ§Ã£o da crew
print("\nğŸš€ Iniciando exegese completa...\n")
resultado = crew.kickoff(inputs={
    "referencia_biblica": referencia_biblica,
})

# âœ… ExibiÃ§Ã£o formatada dos resultados
print("\nğŸ“˜ RESULTADOS EXEGÃ‰TICOS\n" + "="*70)
for idx, task in enumerate(crew.tasks):
    print(f"\nğŸ”¹ [{idx+1}] {task.agent.role}")
    print("-"*60)
    print(task.output)
    print("\n" + "="*70)

# âœ… ConsolidaÃ§Ã£o dos resultados para exportaÃ§Ã£o
resultado_str = ""
for idx, task in enumerate(crew.tasks):
    resultado_str += f"## {task.agent.role}\n\n{task.output}\n\n"

"""âœ… PASSO 8 â€“ Exportar resultado para arquivos .txt e .md"""

from datetime import datetime

# ğŸ“… Nome com timestamp para evitar sobrescrever
timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
nome_base = f"exegese_{referencia_biblica.replace('.', '-').replace(':', '-')}_{timestamp}"

# ğŸ“ Exporta para .txt
with open(f"{nome_base}.txt", "w", encoding="utf-8") as txt_file:
    txt_file.write(resultado_str)

# ğŸ“„ Exporta para .md
with open(f"{nome_base}.md", "w", encoding="utf-8") as md_file:
    md_file.write(resultado_str)

print("\nâœ… Arquivos exportados com sucesso!")
print(f"ğŸ“„ {nome_base}.txt")
print(f"ğŸ“„ {nome_base}.md")